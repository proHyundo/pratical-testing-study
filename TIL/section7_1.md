# 더 나은 테스트를 위한 조언

## 한 문단에 한 주제

- 테스트는 문서로서의 기능을 하기도 한다.
- 문서화의 관점에서 하나의 테스트는 하나의 문단이고, 하나의 문단에는 하나의 주제만 담아야 한다.
- 따라서 하나의 테스트 내부에서 조건문 반복문을 사용해 여러 케이스를 검증하지 말아야 한다.
- DisplayName() 을 하나의 문장으로 작성할 수 있도록 하나의 주제만 테스트 하도록 한다.

## 완벽하게 제어하기

- 시간과 같이 변화하거나, 외부 요인 등과 같이 제어할 수 없는 요소는 테스트에서 문제를 일으킬 수 있다.
- 외부 계층으로 분리하거나, Mocking 하는 것을 권장한다.
- 특히, 현재시간 LocalDateTime.now() 와 같은 요소는 테스트에서 제어할 수 없으므로, 고정 시간을 테스트에서 사용할 것을 권장한다.

## 테스트 환경의 독립성을 보장하자

- 하나의 테스트 내에, 테스트하고자 하는 기능이 아닌 다른 기능때문에 예외/오류/의도와는 다른 문제가 발생할 수 있는 잠재 위험을 가진다.
1. 테스트 하고자 하는 행위(기능) 외 다른 행위(기능)을 포함하지 말 것.
2. given 로직이 필요이상으로 복잡해 지지 않도록 할 것.

## 테스트 간 독립성을 보장하자

- 전역변수로 공유하는 객체가 있다면, 테스트 간의 독립성을 보장할 수 없다.
- @BeforeEach, @AfterEach 등을 사용해 테스트 간의 순서와 독립성을 보장할 수 있다.
  - 테스트를 위해 원하는 상태로 고정시킨 객체를 Test Fixture 라고 한다.

## 한 눈에 들어오는 Test Fixture 구성하기

### 종류

- @BeforeAll : 모든 테스트 메서드가 실행되기 전에 딱 한 번 실행된다.
- @BeforeEach : 각 테스트 메서드가 실행되기 전에 실행된다.
  - E.g. setUp() : 
- @AfterEach : 각 테스트 메서드가 실행된 후에 실행된다.
  - E.g. tearDown() : Repository 초기화.
- @AfterAll : 모든 테스트 메서드가 실행된 후에 딱 한 번 실행된다.

### 특징

- 객체 생성 중복 코드를 없애기 위해 BeforeEach 에서 객체를 생성한 케이스가 종종 있는데, 가급적 지양해야 한다고 한다.
  - 이유1 : TestFixture 와 Test 간 강한 결합도로 인해 TestFixture 에 수정이 일어날 경우 모든 테스트에 영향을 줄 수 있다.
  - 이유2 : TestFixture 로 대체된 given 을 이해하기 위해 스크롤을 위아래로 많이 움직여야 할 수 있다. 즉, 파편화된 정보로 인해 테스트를 이해하는 것이 수월하지 않을 수 있다.
- 다음 두 조건을 충족하면 @BeforeEach 를 통해 Test Fixture 를 세팅해도 좋다.
  1. 각 테스트 입장에서, 아예 몰라도 테스트 내용을 이해하는데 문제가 없는 경우.
  2. @BeforeEach 에서 수정이 일어나도 각 테스트에 영향이 없는 경우.
  - E.g.) 테스트에 필요한 A 객체를 생성할 때 필요한 인자들을 세팅하는 경우.

### 객체 생성 빌더 패턴

- 각 테스트 내부에서 빌더패턴을 사용해 객체를 생성하면 코드가 길어지니, private method 로 extract 할 수 있다.
- 이때, extract 한 create 메서드의 파라미터에는 테스트에서 사용되지 않은 파라미터는 없애고 속성 값을 고정시키는 것을 권장한다.

## Test Fixture 클렌징 (Feat. DeleteAll, DeleteAllInBatch)

- DeleteAllInBatch
  - 참조제약을 고려하여 Repository 의 삭제 순서를 지켜야 한다.
  - 테이블의 데이터를 한번에 삭제한다.
- DeleteAll
  - 테이블의 데이터를 행마다 하나씩 삭제한다.
  - ~~대신, 참조제약을 고려해 삭제 순서를 지키지 않아도 된다.~~ 고려하긴 해야 한다. (보충 필요)
  - 데이터 삭제 전 테이블을 전체를 조회해 참조제약이 걸린 관계를 확인한다.

## @ParameterizedTest

- 

## @DynamicTest


## 테스트 수행도 비용이다. 환경 통합하기


## private 메서드의 테스트는 어떻게 하나요?


## 테스트에서만 필요한 메서드가 생겼는데 프로덕션 코드에서는 필요 없다면?